<script>
// Общие функции
async function submitAnalysisForm(formId, endpoint) {
    const form = document.getElementById(formId);
    if (!form) return;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = form.querySelector('[type="submit"]');
        const originalText = submitBtn.textContent;
        
        try {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';

            const formData = new FormData(form);

            const response = await fetch(endpoint, {
                method: 'POST',
                body: formData,
                credentials: 'include', // This ensures cookies are sent
                headers: {
                    'Accept': 'application/json'
                }
            });

            const result = await response.json();
            
            if (response.ok) {
                alert(`Analysis started! Job ID: ${result.job_id}\nStatus: ${result.status}`);
            } else {
                throw new Error(result.detail || 'Unknown error');
            }
        } catch (error) {
            alert('Error submitting form: ' + error.message);
            console.error('Submission error:', error);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });
}

// Initialize form handlers
document.addEventListener('DOMContentLoaded', () => {
    submitAnalysisForm('illuminaForm', '/api/analysis/illumina');
    submitAnalysisForm('nanoporeForm', '/api/analysis/nanopore');
});

// Функция проверки авторизации
async function checkAuth() {
    try {
        const response = await fetch('/api/auth/check', {
            method: 'GET',
            credentials: 'include'
        });
        return response.ok;
    } catch (error) {
        console.error('Auth check failed:', error);
        return false;
    }
}

// Dropdown меню 
document.querySelectorAll('.dropdown__toggle').forEach(btn => {
    btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.target.nextElementSibling.classList.toggle('dropdown__menu--show');
    });
});

// Закрытие при клике вне меню
window.addEventListener('click', (e) => {
    if (!e.target.matches('.dropdown__toggle')) {
        document.querySelectorAll('.dropdown__menu').forEach(menu => {
            menu.classList.remove('dropdown__menu--show');
        });
    }
});

// Управление модальным окном
document.addEventListener('DOMContentLoaded', () => {
    // Закрытие модального окна
    document.querySelectorAll('.close-modal').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.style.display = 'none';
            });
        });
    });

    // Открытие модального окна при попытке отправить форму незарегистрированным пользователем
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', (e) => {
            const submitBtn = form.querySelector('[type="submit"]');
            if (submitBtn && submitBtn.disabled) {
                e.preventDefault();
                const modal = document.getElementById('registrationModal');
                if (modal) modal.style.display = 'block';
            }
        });
    });

    // Закрытие при клике вне модального окна
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
});
</script>