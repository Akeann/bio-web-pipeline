{% extends "base.html" %}

{% block title %}Research Registration{% endblock %}

{% block content %}
<div class="research-form">
    <div class="research-form__container">
        <div class="content-container mb--md">
            <p>
                Our web server is provided FREE for use in research and education.<br><br>
                To run the pipeline, please fill in the information requested below.
            </p>
        </div>

        <form id="registerForm" class="form">
            <!-- Основные поля -->
            <div class="form__group">
                <label class="form__label" for="username">Username:</label>
                <input type="text" id="username" name="username" class="form__control" required>
                <p class="text--sm">This will be your login name</p>
            </div>

            <div class="form__group">
                <label class="form__label" for="email">Email:</label>
                <input type="email" id="email" name="email" class="form__control" required>
                <p class="email-hint">Results will be sent to this email</p>
            </div>

            <div class="form__group">
                <label class="form__label" for="password">Password:</label>
                <input type="password" id="password" name="password" class="form__control" required>
            </div>

            <div class="form__group">
                <label class="form__label" for="full_name">Full Name (optional):</label>
                <input type="text" id="full_name" name="full_name" class="form__control">
            </div>

            <!-- Дополнительные поля -->
            <div class="form__group">
                <label class="form__label" for="country">Country:</label>
                <select id="country" name="country" class="form__control">
                    <option value="usa">United States</option>
                    <option value="uk">United Kingdom</option>
                    <option value="other">Other</option>
                </select>
            </div>

            <div class="flex flex--row gap--md mb--md">
                <div class="form__group">
                    <label class="form__label" for="role">I am a:</label>
                    <select id="role" name="role" class="form__control">
                        <option value="student">Student</option>
                        <option value="researcher">Researcher</option>
                    </select>
                </div>
                <div class="form__group">
                    <label class="form__label" for="institution_type">Institution type:</label>
                    <select id="institution_type" name="institution_type" class="form__control">
                        <option value="university">University</option>
                        <option value="company">Company</option>
                    </select>
                </div>
            </div>

            <div class="text--center">
                <button type="submit" class="button button--primary" id="submitBtn">Register</button>
            </div>
        </form>
    </div>
</div>

<script>
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const originalText = submitBtn.textContent;
    
    try {
        // Блокируем кнопку и меняем текст
        submitBtn.disabled = true;
        submitBtn.textContent = 'Processing...';
        
        // Собираем данные формы
        const formData = {
            username: document.getElementById('username').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            full_name: document.getElementById('full_name').value || undefined,
            country: document.getElementById('country').value || undefined,
            role: document.getElementById('role').value || undefined,
            institution_type: document.getElementById('institution_type').value || undefined
        };

        // Отправляем данные на сервер
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Registration failed. Please try again.');
        }
        
        // Успешная регистрация - редирект на страницу входа
        window.location.href = '/auth/login?from_registration=true&email=' + 
                             encodeURIComponent(formData.email);
        
    } catch (err) {
        console.error('Registration error:', err);
        alert(err.message);
    } finally {
        // Восстанавливаем кнопку
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
    }
});
</script>
{% endblock %}